---
// Enhanced navigation component - WCAG 2.2 Level AA compliant
// Includes skip links, proper ARIA labels, and keyboard navigation

import { Image } from "astro:assets";
import AccessibilityStore from "../../utils/accessibilityStore";

const navLinks = [
  {
    name: "Home",
    href: "/",
    ariaLabel: "Navigate to home page"
  },
  {
    name: "Services",
    href: "/services",
    ariaLabel: "View our hosting services"
  },
  {
    name: "About",
    href: "/about",
    ariaLabel: "Learn about Premium Hosting"
  },
  {
    name: "Blog",
    href: "/blog",
    ariaLabel: "Read our latest articles"
  },
  {
    name: "Contact",
    href: "/contact",
    ariaLabel: "Get in touch with us"
  },
];

const bars = "../../assets/bars.svg";
const brand = "../../assets/premium-hosting-horizontal-logo.svg";

// Accessibility store integration for panel toggle
const accessibilityStore = AccessibilityStore.getInstance();
---

<div
  class="bg-black fixed w-full top-0 z-10 py-[30px] h-auto flex justify-center px-4"
  itemscope
  itemtype="https://schema.org/SiteNavigationElement"
>
  <nav
    id="main-navigation"
    aria-label="Main Navigation"
    role="navigation"
    class="w-full flex h-full items-center justify-between"
    itemscope
    itemtype="https://schema.org/SiteNavigationElement"
  >
    <!-- Brand -->
    <div class="pl-4 xl:flex-none">
      <a
        href="/"
        aria-label="Premium Hosting - UK Business Web Hosting Services"
        class="brand-link"
        itemprop="url"
      >
        <Image
          src={brand}
          alt="Premium Hosting Logo"
          class="w-[219px]"
          loading="eager"
          width="219"
          height="45"
        />
        <meta itemprop="name" content="Premium Hosting" />
      </a>
    </div>



    <!-- Nav Menu -->
    <div
      id="navmenu"
      class="bg-[#D4AF37] w-full absolute top-full z-10 xl:static xl:flex xl:flex-grow xl:items-center xl:justify-center overflow-hidden transition-height duration-500 h-0 xl:h-auto rounded-xl"
      style="max-width: 1280px;"
    >
      <!-- Nav Links -->
      <ul
        class="xl:flex xl:flex-grow xl:justify-center xl:gap-10"
        role="menubar"
        itemscope
        itemtype="https://schema.org/SiteNavigationElement"
      >
        {
          navLinks.map((link) => {
            return (
              <li
                class="mx-4 p-4 xl:mx-0 px-0"
                role="none"
                itemprop="name"
              >
                <a
                  href={link.href}
                  class="nav-link block"
                  role="menuitem"
                  aria-label={link.ariaLabel}
                  itemprop="url"
                  onkeydown="handleNavKeydown(event)"
                >
                  <span itemprop="name">{link.name}</span>
                </a>
              </li>
            );
          })
        }
      </ul>

      <!-- Actions -->
      <div class="flex xl:flex-row xl:items-center p-6 xl:gap-4 flex-col">
        <a
          href="/contact"
          class="cta-button bg-[#1a0033] text-white px-[35px] py-5 rounded-lg border border-solid border-[#1a0033] transition-all duration-200 hover:bg-[#2a004d] transform hover:scale-105 inline-block text-center"
          aria-label="Request a hosting quote - opens contact form"
          role="button"
        >
          Request a quote
        </a>
      </div>
    </div>

    <!-- Header Actions -->
    <div class="flex items-center gap-4 pr-4 xl:pr-0">
      <!-- Accessibility Panel Toggle -->
      <button
        class="accessibility-toggle text-white hover:text-[#D4AF37] transition-colors p-2"
        aria-label="Open accessibility settings panel"
        aria-expanded="false"
        data-accessibility-toggle
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </button>

      <!-- Account Icon -->
      <button
        class="text-white hover:text-[#D4AF37] transition-colors p-2 account-button"
        aria-label="Account login and management"
        aria-haspopup="dialog"
        type="button"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>
      </button>

      <!-- Shopping Cart -->
      <button
        class="text-white hover:text-[#D4AF37] transition-colors p-2 cart-button relative"
        aria-label="Shopping cart with 0 items"
        type="button"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.1 5H19M7 13l-1.1 5M7 13l1.1-5m8.9 5L17 18m2-5l1.1-5M9 21a1 1 0 11-2 0 1 1 0 012 0zm8 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
        </svg>
        <!-- Cart badge (hidden when 0 for accessibility) -->
        <span
          class="absolute -top-1 -right-1 bg-[#D4AF37] text-[#1a0033] text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold cart-count"
          aria-hidden="true"
          style="display: none;"
        >
          0
        </span>
      </button>
    </div>

    <!-- Hamburger menu -->
    <button
      aria-label="menu"
      role="button"
      aria-controls="navmenu"
      aria-expanded="false"
      id="menuButton"
      class="w-12 h-12 xl:hidden pr-4 cursor-pointer"
    >
      <Image src={bars} alt="hamburgerIcon" class="hamburgerIcon" />
    </button>
  </nav>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const menuButton = document.getElementById("menuButton");
    const navMenu = document.getElementById("navmenu");
    const accessibilityToggle = document.querySelector('[data-accessibility-toggle]');
    const navLinks = document.querySelectorAll('.nav-link');

    let isMenuOpen = false;

    // Mobile menu functionality
    if (menuButton && navMenu) {
      menuButton.addEventListener("click", () => {
        isMenuOpen = !isMenuOpen;
        menuButton.setAttribute("aria-expanded", `${isMenuOpen}`);

        if (isMenuOpen) {
          navMenu.style.height = `${navMenu.scrollHeight}px`;
          // Focus first nav link
          const firstLink = navMenu.querySelector('.nav-link');
          if (firstLink) setTimeout(() => firstLink.focus(), 100);
        } else {
          navMenu.style.height = "0px";
        }
      });

      navMenu.addEventListener("click", () => {
        /* Close menu after using it */
        if (isMenuOpen) {
          isMenuOpen = false;
          navMenu.style.height = "0px";
          menuButton.focus(); // Return focus to menu button
        }
      });

      window.addEventListener("resize", () => {
        /* Resize cleanup screen state*/
        if (window.innerWidth >= 1280) {
          /* Add height if menu was closed and then resize happened */
          navMenu.style.height = "auto";
          navMenu.classList.remove("h-0");
        } else {
          /* Prevent opened menu when going from bit to small */
          navMenu.style.height = "0px";
        }
      });
    }

    // Accessibility panel toggle
    if (accessibilityToggle) {
      accessibilityToggle.addEventListener('click', () => {
        // Import accessibility store dynamically to avoid initialization issues
        import('../../utils/accessibilityStore').then(({ AccessibilityStore }) => {
          const store = AccessibilityStore.getInstance();
          store.togglePanel();
        }).catch(error => {
          console.warn('Failed to toggle accessibility panel:', error);
        });
      });
    }

    // Keyboard navigation for navigation links
    navLinks.forEach((link, index) => {
      link.addEventListener('keydown', (event) => {
        const links = Array.from(navLinks);
        const currentIndex = links.indexOf(link);

        switch (event.key) {
          case 'ArrowRight':
          case 'ArrowDown':
            event.preventDefault();
            const nextIndex = (currentIndex + 1) % links.length;
            links[nextIndex].focus();
            break;
          case 'ArrowLeft':
          case 'ArrowUp':
            event.preventDefault();
            const prevIndex = currentIndex === 0 ? links.length - 1 : currentIndex - 1;
            links[prevIndex].focus();
            break;
          case 'Home':
            event.preventDefault();
            links[0].focus();
            break;
          case 'End':
            event.preventDefault();
            links[links.length - 1].focus();
            break;
          case 'Escape':
            // Close mobile menu if open and return to menu button
            if (isMenuOpen && menuButton) {
              isMenuOpen = false;
              navMenu.style.height = "0px";
              menuButton.focus();
            }
            break;
        }
      });
    });

    // Current page highlighting
    const currentPath = window.location.pathname;
    navLinks.forEach(link => {
      const href = link.getAttribute('href');
      if (href === '/' && currentPath === '/') {
        link.classList.add('current-page');
        link.setAttribute('aria-current', 'page');
      } else if (href !== '/' && currentPath.startsWith(href)) {
        link.classList.add('current-page');
        link.setAttribute('aria-current', 'page');
      }
    });
  });

  // Global keyboard shortcut for navigation
  document.addEventListener('keydown', (event) => {
    // Alt + N: Focus main navigation
    if (event.altKey && (event.key === 'n' || event.key === 'N')) {
      event.preventDefault();
      const mainNav = document.getElementById('main-navigation');
      if (mainNav) {
        const firstLink = mainNav.querySelector('.nav-link');
        if (firstLink) firstLink.focus();
      }
    }
  });
</script>

<!-- 
  Use to highlight the active link in the navigation bar
  Gotta test in dev and prod bc sometimes it doesn't work
---
const pathname = new URL(Astro.request.url).pathname;
const currentPath = pathname.slice(1); // remove the first "/"
---

<nav>
  <a class={currentPath === "" ? "active" : ""} href="/">Home</a>
  <a class={currentPath === "portfolio" ? "active" : ""} href="/portfolio">Portfolio</a>
  <a class={currentPath === "posts" ? "active" : ""} href="/posts">Article</a>
  <a class={currentPath === "about" ? "active" : ""} href="/about">About Me</a>
  <a class={currentPath === "contact" ? "active" : ""} href="/contact">Contact Me</a>
</nav>
-->
